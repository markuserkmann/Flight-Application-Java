<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="/Booking.css">
    <title>Istekohad</title>
</head>
<body>
<div class="plane">
    <div class="cockpit">
        <h1>Istekohad</h1>
    </div>
    <div class="exit exit--front fuselage"></div>
    <ol class="cabin fuselage">
        <li class="row row--1">
            <ol class="seats" type="A">
                <li class="seat">
                    <input type="checkbox" id="1A" />
                    <label for="1A">1A</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="1B" />
                    <label for="1B">1B</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="1C" />
                    <label for="1C">1C</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="1D" />
                    <label for="1D">1D</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="1E" />
                    <label for="1E">1E</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="1F" />
                    <label for="1F">1F</label>
                </li>
            </ol>
        </li>

        <li class="row row--2">
            <ol class="seats" type="A">
                <li class="seat">
                    <input type="checkbox" id="2A" />
                    <label for="2A">2A</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="2B" />
                    <label for="2B">2B</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="2C" />
                    <label for="2C">2C</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="2D" />
                    <label for="2D">2D</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="2E" />
                    <label for="2E">2E</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="2F" />
                    <label for="2F">2F</label>
                </li>
            </ol>
        </li>

        <li class="row row--3">
            <ol class="seats" type="A">
                <li class="seat">
                    <input type="checkbox" id="3A" />
                    <label for="3A">3A</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="3B" />
                    <label for="3B">3B</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="3C" />
                    <label for="3C">3C</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="3D" />
                    <label for="3D">3D</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="3E" />
                    <label for="3E">3E</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="3F" />
                    <label for="3F">3F</label>
                </li>
            </ol>
        </li>
        <li class="row row--4">
            <ol class="seats" type="A">
                <li class="seat">
                    <input type="checkbox" id="4A" />
                    <label for="4A">4A</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="4B" />
                    <label for="4B">4B</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="4C" />
                    <label for="4C">4C</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="4D" />
                    <label for="4D">4D</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="4E" />
                    <label for="4E">4E</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="4F" />
                    <label for="4F">4F</label>
                </li>
            </ol>
        </li>
        <li class="row row--5">
            <ol class="seats" type="A">
                <li class="seat">
                    <input type="checkbox" id="5A" />
                    <label for="5A">5A</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="5B" />
                    <label for="5B">5B</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="5C" />
                    <label for="5C">5C</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="5D" />
                    <label for="5D">5D</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="5E" />
                    <label for="5E">5E</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="5F" />
                    <label for="5F">5F</label>
                </li>
            </ol>
        </li>
        <li class="row row--6">
            <ol class="seats" type="A">
                <li class="seat">
                    <input type="checkbox" id="6A" />
                    <label for="6A">6A</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="6B" />
                    <label for="6B">6B</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="6C" />
                    <label for="6C">6C</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="6D" />
                    <label for="6D">6D</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="6E" />
                    <label for="6E">6E</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="6F" />
                    <label for="6F">6F</label>
                </li>
            </ol>
        </li>
        <li class="row row--7">
            <ol class="seats" type="A">
                <li class="seat">
                    <input type="checkbox" id="7A" />
                    <label for="7A">7A</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="7B" />
                    <label for="7B">7B</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="7C" />
                    <label for="7C">7C</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="7D" />
                    <label for="7D">7D</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="7E" />
                    <label for="7E">7E</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="7F" />
                    <label for="7F">7F</label>
                </li>
            </ol>
        </li>
        <li class="row row--8">
            <ol class="seats" type="A">
                <li class="seat">
                    <input type="checkbox" id="8A" />
                    <label for="8A">8A</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="8B" />
                    <label for="8B">8B</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="8C" />
                    <label for="8C">8C</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="8D" />
                    <label for="8D">8D</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="8E" />
                    <label for="8E">8E</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="8F" />
                    <label for="8F">8F</label>
                </li>
            </ol>
        </li>
        <li class="row row--9">
            <ol class="seats" type="A">
                <li class="seat">
                    <input type="checkbox" id="9A" />
                    <label for="9A">9A</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="9B" />
                    <label for="9B">9B</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="9C" />
                    <label for="9C">9C</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="9D" />
                    <label for="9D">9D</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="9E" />
                    <label for="9E">9E</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="9F" />
                    <label for="9F">9F</label>
                </li>
            </ol>
        </li>
        <li class="row row--10">
            <ol class="seats" type="A">
                <li class="seat">
                    <input type="checkbox" id="10A" />
                    <label for="10A">10A</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="10B" />
                    <label for="10B">10B</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="10C" />
                    <label for="10C">10C</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="10D" />
                    <label for="10D">10D</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="10E" />
                    <label for="10E">10E</label>
                </li>
                <li class="seat">
                    <input type="checkbox" id="10F" />
                    <label for="10F">10F</label>
                </li>
            </ol>
        </li>
    </ol>
    <div class="exit exit--back fuselage"></div>

    <!-- The plane ui is gotten from a component library -->

    <div class="selected-display p-4">
        <h3 class="text-xl font-semibold mb-2">Valitud kohad (<span id="selectedCount">0</span>)</h3>
        <div id="selectedSeatsList" class="space-y-2"></div>
    </div>

    <div class="fixed left-4 top-20 bg-white p-6 border border-gray-300 rounded-lg shadow-lg max-w-xs">
        <h2 class="text-2xl font-bold mb-4">Istmete soovitamine</h2>
        <div class="flex flex-col space-y-3">
            <button onclick="SuggestWindowSeats()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded">
                Akna äärsed istmed
            </button>
            <button onclick="suggestExtraLegRoomSeats()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded">
                Lisa jalaruum
            </button>
            <button onclick="suggestExitRowSeats()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded">
                Väljapääsu lähedal
            </button>
            <div class="flex items-center space-x-2 mt-2">
                <input type="number" id="groupSize" min="1" max="3" value="1" class="w-16 p-2 border border-gray-300 rounded" />
                <button onclick="suggestAdjacent()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded">
                    Lähestikku istmed
                </button>
            </div>
        </div>
        <div id="suggestionResult" class="mt-4 text-gray-600"></div>
    </div>


    <div class="fixed right-4 top-20 bg-white p-6 border border-gray-300 rounded-lg shadow-lg max-w-xs">
        <h2 class="text-2xl font-bold mb-4">Osta pilet</h2>
        <div id="summaryList" class="space-y-2"></div>
        <div id="totalPrice" class="mt-4 font-bold"></div>
        <button onclick="purchaseTickets()" class="mt-4 bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded w-full">
            Osta
        </button>
    </div>
</div>

<style>
    .seat label {
        transition: all 0.3s ease;
    }
    .seat label.suggested {
        background: #5C6AFF !important;
        color: white;
        animation: pulse 1.5s infinite;
    }
    .seat label.suggested:hover {
        background: #4CAF50 !important;
        cursor: pointer;
    }
    .seat input[type=checkbox]:checked + label.suggested {
        background: #4CAF50 !important;
        animation: none;
    }
    .seat input[type=checkbox]:checked + label {
        background: #bada55;
    }
</style>

<script th:inline="javascript">
    const flightData = [[${flight}]];
    document.addEventListener("DOMContentLoaded", () => {
        const seatIds = [];
        flightData.seats.seats.forEach(seat => {
            const checkbox = document.getElementById(seat.seat_number);
            if (checkbox) {
                checkbox.disabled = seat.occupied;
                const label = checkbox.nextElementSibling;
                label.textContent = seat.occupied ? "Occupied" : seat.seat_number;
                seatIds.push(seat.seat_number);
                label.classList.toggle("occupied", seat.occupied);
            }
        });
    });

    const rows = document.querySelectorAll('.row');
    rows.forEach((row, index) => {
        let classType = 'economy';
        if (index === 0 || index === 1) {
            classType = 'business';
        } else if (index === 2 || index === 3) {
            classType = 'premium';
        }
        row.classList.add(classType);
        row.setAttribute('data-seat-class', classType);
    });

    document.addEventListener("DOMContentLoaded", () => {
        updateSelectedDisplay();
        document.querySelector('.cabin').addEventListener('change', (e) => {
            if (e.target.matches('.seat input[type="checkbox"]')) {
                updateSelectedDisplay();
            }
        });
    });

    function updateSelectedDisplay() {
        const selected = Array.from(document.querySelectorAll('.seat input:checked'))
            .map(seat => seat.id);

        const listContainer = document.getElementById('selectedSeatsList');
        const countSpan = document.getElementById('selectedCount');

        countSpan.textContent = selected.length;

        listContainer.innerHTML = selected
            .map(id => `
          <div class="selected-seat-item flex justify-between items-center">
            <span>Istekoht ${id}</span>
            <button onclick="DeSelectSeat('${id}')" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-3 py-1">
              Eemalda
            </button>
          </div>
        `).join('');

        updatePurchaseSummary();
    }

    function DeSelectSeat(seatId) {
        const seat = document.getElementById(seatId);
        if (seat) {
            seat.checked = false;
            updateSelectedDisplay();
        }
    }

    function getAvailableSeats() {
        return Array.from(document.querySelectorAll('.seat input:not(:disabled)'))
            .map(seat => seat.id);
    }

    function highlightSeats(seatIds) {
        document.querySelectorAll('.seat label').forEach(label => {
            label.classList.remove('suggested');
        });
        seatIds.forEach(id => {
            const label = document.querySelector(`label[for="${id}"]`);
            if (label && !label.previousElementSibling.disabled) {
                label.classList.add('suggested');
            }
        });
    }

    function SuggestWindowSeats() {
        const windowSeats = getAvailableSeats().filter(id => {
            const seatLetter = id.slice(-1);
            return ['A', 'F'].includes(seatLetter);
        });
        highlightSeats(windowSeats);
    }

    function suggestExtraLegRoomSeats() {
        const legroomRows = [1, 2, 9, 10];
        const legroomSeats = getAvailableSeats().filter(id => {
            const rowNumber = parseInt(id.match(/\d+/)[0]);
            return legroomRows.includes(rowNumber);
        });
        highlightSeats(legroomSeats);
    }

    function suggestExitRowSeats() {
        const exitRows = [1, 10];
        const exitSeats = getAvailableSeats().filter(id => {
            const rowNumber = parseInt(id.match(/\d+/)[0]);
            return exitRows.includes(rowNumber);
        });
        highlightSeats(exitSeats);
    }

    function suggestAdjacent() {
        const groupSize = parseInt(document.getElementById('groupSize').value) || 1;
        const allAvailableSeats = getAvailableSeats();

        let foundGroup = null;
        const rows = Array.from({length: 10}, (_, i) => i + 1);

        for (const row of rows) {
            const rowSeats = allAvailableSeats.filter(id => parseInt(id.match(/\d+/)[0]) === row);
            const groups = {
                left: rowSeats.filter(id => ['A', 'B', 'C'].includes(id.slice(-1))),
                right: rowSeats.filter(id => ['D', 'E', 'F'].includes(id.slice(-1)))
            };

            for (const side of ['left', 'right']) {
                if (groups[side].length >= groupSize) {
                    const sorted = groups[side].sort();
                    for (let i = 0; i <= sorted.length - groupSize; i++) {
                        const group = sorted.slice(i, i + groupSize);
                        if (IsNextToEachOther(group)) {
                            foundGroup = group;
                            break;
                        }
                    }
                    if (foundGroup) break;
                }
            }
            if (foundGroup) break;
        }

        if (foundGroup) {
            highlightSeats(foundGroup);
        } else {
            document.getElementById('suggestionResult').textContent =
                'Ei leitud ühtegi kõrvuti istet!';
        }
    }

    function IsNextToEachOther(seatIds) {
        const letters = seatIds.map(id => id.charCodeAt(id.length - 1));
        for (let i = 1; i < letters.length; i++) {
            if (letters[i] - letters[i - 1] !== 1) return false;
        }
        return true;
    }

    function updatePurchaseSummary() {
        const prices = {
            business: flightData.flightPrice + 150,
            premium: flightData.flightPrice + 100,
            economy: flightData.flightPrice
        };

        // Translations, so there is no need for changing the class names in the code to Estonian
        const classTranslations = {
            business: 'Äriklass',
            premium: 'PreemiumKlass',
            economy: 'Turistiklass'
        };

        const SelectedSeats = Array.from(document.querySelectorAll('.seat input:checked'));
        let summaryHtml = '';
        let totalPrice = 0;

        SelectedSeats.forEach(seat => {
            const seatId = seat.id;
            const rowElement = seat.closest('.row');
            const seatClass = rowElement ? rowElement.getAttribute('data-seat-class') : 'economy';
            const price = prices[seatClass];
            totalPrice += price;
            const translatedClass = classTranslations[seatClass] || seatClass;
            summaryHtml += `<div class="flex justify-between items-center">
            <span>${seatId} (${translatedClass}) </span>
            <span class="font-bold"> ${price}€</span>
          </div>`;
        });

        document.getElementById('summaryList').innerHTML = summaryHtml;
        document.getElementById('totalPrice').textContent = `Kokku: ${totalPrice}€`;
    }


    function purchaseTickets() {
        const selectedCheckboxes = Array.from(document.querySelectorAll('.seat input:checked'));
        if (selectedCheckboxes.length === 0) {
            alert("Palun vali vähemalt üks koht!");
            return;
        }
        let message = "Valitud piletid:\n";
        selectedCheckboxes.forEach(checkbox => {
            const seatId = checkbox.id;
            const rowElement = checkbox.closest('.row');
            const seatClass = rowElement ? rowElement.getAttribute('data-seat-class') : 'economy';
            message += `${seatId} (${seatClass})\n`;
        });
        alert(message);
    }
</script>
</body>
</html>
